<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>utils/DeduplicationManager.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BatchPublisher.html">BatchPublisher</a></li><li><a href="BoxQ.html">BoxQ</a></li><li><a href="CircuitBreaker.html">CircuitBreaker</a></li><li><a href="DeduplicationManager.html">DeduplicationManager</a></li><li><a href="HealthMonitor.html">HealthMonitor</a></li><li><a href="MessageConsumer.html">MessageConsumer</a></li><li><a href="MessagePublisher.html">MessagePublisher</a></li><li><a href="ProcessingEngine.html">ProcessingEngine</a></li><li><a href="RetryManager.html">RetryManager</a></li><li><a href="SQSClient.html">SQSClient</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">utils/DeduplicationManager.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Deduplication Manager for BoxQ
 * @author Ankur Mahajan
 * @version 1.0.0
 */

const crypto = require('crypto');

/**
 * Deduplication Manager class for handling message deduplication
 * Provides content-based deduplication strategies for FIFO queues
 */
class DeduplicationManager {
  /**
   * Creates a new DeduplicationManager instance
   * @param {Object} config - Deduplication configuration
   * @param {string} [config.strategy='content'] - Deduplication strategy
   * @param {string} [config.hashAlgorithm='sha256'] - Hash algorithm for content hashing
   * @param {number} [config.hashLength=32] - Length of hash to use
   */
  constructor(config = {}) {
    this.strategy = config.strategy || 'content';
    this.hashAlgorithm = config.hashAlgorithm || 'sha256';
    this.hashLength = config.hashLength || 32;
    this.deduplicationCache = new Map();
    this.cacheExpiry = 300000; // 5 minutes
  }

  /**
   * Generates a deduplication ID for a message
   * @param {Object} messageBody - Message body
   * @param {Object} options - Message options
   * @param {string} [options.messageGroupId] - Message group ID
   * @param {string} [options.customId] - Custom ID for deduplication
   * @returns {string} Deduplication ID
   */
  generateDeduplicationId = (messageBody, options = {}) => {
    if (options.customId) {
      return this._hashString(options.customId);
    }

    if (this.strategy === 'content') {
      return this._generateContentBasedId(messageBody, options);
    }

    if (this.strategy === 'timestamp') {
      return this._generateTimestampBasedId();
    }

    if (this.strategy === 'hybrid') {
      return this._generateHybridId(messageBody, options);
    }

    // Default to content-based
    return this._generateContentBasedId(messageBody, options);
  };

  /**
   * Generates content-based deduplication ID
   * @private
   * @param {Object} messageBody - Message body
   * @param {Object} options - Message options
   * @returns {string} Content-based deduplication ID
   */
  _generateContentBasedId = (messageBody, options) => {
    const contentForHash = {
      body: messageBody,
      groupId: options.messageGroupId,
      timestamp: Date.now(),
      random: Math.random().toString(36).substring(2)
    };
    
    return this._hashObject(contentForHash);
  };

  /**
   * Generates timestamp-based deduplication ID
   * @private
   * @returns {string} Timestamp-based deduplication ID
   */
  _generateTimestampBasedId = () => {
    const timestamp = Date.now();
    return this._hashString(timestamp.toString());
  };

  /**
   * Generates hybrid deduplication ID
   * @private
   * @param {Object} messageBody - Message body
   * @param {Object} options - Message options
   * @returns {string} Hybrid deduplication ID
   */
  _generateHybridId = (messageBody, options) => {
    const contentHash = this._hashObject(messageBody);
    const timestamp = Date.now();
    const groupId = options.messageGroupId || 'default';
    
    return this._hashString(`${contentHash}-${timestamp}-${groupId}`);
  };

  /**
   * Hashes an object to create a deduplication ID
   * @private
   * @param {Object} obj - Object to hash
   * @returns {string} Hash string
   */
  _hashObject = (obj) => {
    const str = JSON.stringify(obj, Object.keys(obj).sort());
    return this._hashString(str);
  };

  /**
   * Hashes a string using the configured algorithm
   * @private
   * @param {string} str - String to hash
   * @returns {string} Hash string
   */
  _hashString = (str) => {
    const hash = crypto.createHash(this.hashAlgorithm);
    hash.update(str);
    return hash.digest('hex').substring(0, this.hashLength);
  };

  /**
   * Checks if a message is a duplicate
   * @param {string} deduplicationId - Deduplication ID to check
   * @returns {boolean} True if message is a duplicate
   */
  isDuplicate = (deduplicationId) => {
    const now = Date.now();
    
    // Clean expired entries
    for (const [id, timestamp] of this.deduplicationCache) {
      if (now - timestamp > this.cacheExpiry) {
        this.deduplicationCache.delete(id);
      }
    }
    
    if (this.deduplicationCache.has(deduplicationId)) {
      return true;
    }
    
    this.deduplicationCache.set(deduplicationId, now);
    return false;
  };

  /**
   * Clears the deduplication cache
   */
  clearCache = () => {
    this.deduplicationCache.clear();
  };

  /**
   * Gets cache statistics
   * @returns {Object} Cache statistics
   */
  getCacheStats = () => {
    const now = Date.now();
    let validEntries = 0;
    let expiredEntries = 0;
    
    for (const [id, timestamp] of this.deduplicationCache) {
      if (now - timestamp > this.cacheExpiry) {
        expiredEntries++;
      } else {
        validEntries++;
      }
    }
    
    return {
      totalEntries: this.deduplicationCache.size,
      validEntries,
      expiredEntries,
      cacheExpiry: this.cacheExpiry
    };
  };

  /**
   * Updates the deduplication configuration
   * @param {Object} config - New configuration
   */
  updateConfig = (config) => {
    if (config.strategy) this.strategy = config.strategy;
    if (config.hashAlgorithm) this.hashAlgorithm = config.hashAlgorithm;
    if (config.hashLength) this.hashLength = config.hashLength;
    if (config.cacheExpiry) this.cacheExpiry = config.cacheExpiry;
  };

  /**
   * Gets the current configuration
   * @returns {Object} Current configuration
   */
  getConfig = () => ({
    strategy: this.strategy,
    hashAlgorithm: this.hashAlgorithm,
    hashLength: this.hashLength,
    cacheExpiry: this.cacheExpiry
  });
}

module.exports = DeduplicationManager;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a> on Mon Oct 27 2025 16:21:49 GMT+0530 (India Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
